var re=(w,y,v)=>{if(!y.has(w))throw TypeError("Cannot "+v)};var L=(w,y,v)=>(re(w,y,"read from private field"),v?v.call(w):y.get(w)),U=(w,y,v)=>{if(y.has(w))throw TypeError("Cannot add the same private member more than once");y instanceof WeakSet?y.add(w):y.set(w,v)},W=(w,y,v,S)=>(re(w,y,"write to private field"),S?S.call(w,v):y.set(w,v),v);var appetize=function(w){var C,T;"use strict";class y{constructor(){this.log=this.createLogFn("log"),this.warn=this.createLogFn("warn"),this.error=this.createLogFn("error"),this.debug=this.createLogFn("log")}createLogFn(e){const t=new Set,s="[Appetize]",i=Function.prototype.bind.call(console[e],console,s);return i.once=r=>{if(!t.has(r))return t.add(r),i.call(console,r)},i}}var v={exports:{}},S=typeof Reflect=="object"?Reflect:null,q=S&&typeof S.apply=="function"?S.apply:function(e,t,s){return Function.prototype.apply.call(e,t,s)},M;S&&typeof S.ownKeys=="function"?M=S.ownKeys:Object.getOwnPropertySymbols?M=function(e){return Object.getOwnPropertyNames(e).concat(Object.getOwnPropertySymbols(e))}:M=function(e){return Object.getOwnPropertyNames(e)};function oe(n){console&&console.warn&&console.warn(n)}var K=Number.isNaN||function(e){return e!==e};function d(){d.init.call(this)}v.exports=d,v.exports.once=le,d.EventEmitter=d,d.prototype._events=void 0,d.prototype._eventsCount=0,d.prototype._maxListeners=void 0;var V=10;function O(n){if(typeof n!="function")throw new TypeError('The "listener" argument must be of type Function. Received type '+typeof n)}Object.defineProperty(d,"defaultMaxListeners",{enumerable:!0,get:function(){return V},set:function(n){if(typeof n!="number"||n<0||K(n))throw new RangeError('The value of "defaultMaxListeners" is out of range. It must be a non-negative number. Received '+n+".");V=n}}),d.init=function(){(this._events===void 0||this._events===Object.getPrototypeOf(this)._events)&&(this._events=Object.create(null),this._eventsCount=0),this._maxListeners=this._maxListeners||void 0},d.prototype.setMaxListeners=function(e){if(typeof e!="number"||e<0||K(e))throw new RangeError('The value of "n" is out of range. It must be a non-negative number. Received '+e+".");return this._maxListeners=e,this};function j(n){return n._maxListeners===void 0?d.defaultMaxListeners:n._maxListeners}d.prototype.getMaxListeners=function(){return j(this)},d.prototype.emit=function(e){for(var t=[],s=1;s<arguments.length;s++)t.push(arguments[s]);var i=e==="error",r=this._events;if(r!==void 0)i=i&&r.error===void 0;else if(!i)return!1;if(i){var o;if(t.length>0&&(o=t[0]),o instanceof Error)throw o;var a=new Error("Unhandled error."+(o?" ("+o.message+")":""));throw a.context=o,a}var h=r[e];if(h===void 0)return!1;if(typeof h=="function")q(h,this,t);else for(var c=h.length,l=X(h,c),s=0;s<c;++s)q(l[s],this,t);return!0};function B(n,e,t,s){var i,r,o;if(O(t),r=n._events,r===void 0?(r=n._events=Object.create(null),n._eventsCount=0):(r.newListener!==void 0&&(n.emit("newListener",e,t.listener?t.listener:t),r=n._events),o=r[e]),o===void 0)o=r[e]=t,++n._eventsCount;else if(typeof o=="function"?o=r[e]=s?[t,o]:[o,t]:s?o.unshift(t):o.push(t),i=j(n),i>0&&o.length>i&&!o.warned){o.warned=!0;var a=new Error("Possible EventEmitter memory leak detected. "+o.length+" "+String(e)+" listeners added. Use emitter.setMaxListeners() to increase limit");a.name="MaxListenersExceededWarning",a.emitter=n,a.type=e,a.count=o.length,oe(a)}return n}d.prototype.addListener=function(e,t){return B(this,e,t,!1)},d.prototype.on=d.prototype.addListener,d.prototype.prependListener=function(e,t){return B(this,e,t,!0)};function ae(){if(!this.fired)return this.target.removeListener(this.type,this.wrapFn),this.fired=!0,arguments.length===0?this.listener.call(this.target):this.listener.apply(this.target,arguments)}function H(n,e,t){var s={fired:!1,wrapFn:void 0,target:n,type:e,listener:t},i=ae.bind(s);return i.listener=t,s.wrapFn=i,i}d.prototype.once=function(e,t){return O(t),this.on(e,H(this,e,t)),this},d.prototype.prependOnceListener=function(e,t){return O(t),this.prependListener(e,H(this,e,t)),this},d.prototype.removeListener=function(e,t){var s,i,r,o,a;if(O(t),i=this._events,i===void 0)return this;if(s=i[e],s===void 0)return this;if(s===t||s.listener===t)--this._eventsCount===0?this._events=Object.create(null):(delete i[e],i.removeListener&&this.emit("removeListener",e,s.listener||t));else if(typeof s!="function"){for(r=-1,o=s.length-1;o>=0;o--)if(s[o]===t||s[o].listener===t){a=s[o].listener,r=o;break}if(r<0)return this;r===0?s.shift():ce(s,r),s.length===1&&(i[e]=s[0]),i.removeListener!==void 0&&this.emit("removeListener",e,a||t)}return this},d.prototype.off=d.prototype.removeListener,d.prototype.removeAllListeners=function(e){var t,s,i;if(s=this._events,s===void 0)return this;if(s.removeListener===void 0)return arguments.length===0?(this._events=Object.create(null),this._eventsCount=0):s[e]!==void 0&&(--this._eventsCount===0?this._events=Object.create(null):delete s[e]),this;if(arguments.length===0){var r=Object.keys(s),o;for(i=0;i<r.length;++i)o=r[i],o!=="removeListener"&&this.removeAllListeners(o);return this.removeAllListeners("removeListener"),this._events=Object.create(null),this._eventsCount=0,this}if(t=s[e],typeof t=="function")this.removeListener(e,t);else if(t!==void 0)for(i=t.length-1;i>=0;i--)this.removeListener(e,t[i]);return this};function z(n,e,t){var s=n._events;if(s===void 0)return[];var i=s[e];return i===void 0?[]:typeof i=="function"?t?[i.listener||i]:[i]:t?he(i):X(i,i.length)}d.prototype.listeners=function(e){return z(this,e,!0)},d.prototype.rawListeners=function(e){return z(this,e,!1)},d.listenerCount=function(n,e){return typeof n.listenerCount=="function"?n.listenerCount(e):J.call(n,e)},d.prototype.listenerCount=J;function J(n){var e=this._events;if(e!==void 0){var t=e[n];if(typeof t=="function")return 1;if(t!==void 0)return t.length}return 0}d.prototype.eventNames=function(){return this._eventsCount>0?M(this._events):[]};function X(n,e){for(var t=new Array(e),s=0;s<e;++s)t[s]=n[s];return t}function ce(n,e){for(;e+1<n.length;e++)n[e]=n[e+1];n.pop()}function he(n){for(var e=new Array(n.length),t=0;t<e.length;++t)e[t]=n[t].listener||n[t];return e}function le(n,e){return new Promise(function(t,s){function i(o){n.removeListener(e,r),s(o)}function r(){typeof n.removeListener=="function"&&n.removeListener("error",i),t([].slice.call(arguments))}Y(n,e,r,{once:!0}),e!=="error"&&ue(n,i,{once:!0})})}function ue(n,e,t){typeof n.on=="function"&&Y(n,"error",e,t)}function Y(n,e,t,s){if(typeof n.on=="function")s.once?n.once(e,t):n.on(e,t);else if(typeof n.addEventListener=="function")n.addEventListener(e,function i(r){s.once&&n.removeEventListener(e,i),t(r)});else throw new TypeError('The "emitter" argument must be of type EventEmitter. Received type '+typeof n)}class R extends v.exports.EventEmitter{constructor(){super(),this.on("error",()=>{})}}class de extends R{constructor({socket:e}){super(),this._socket=e,e.on("*",({type:t,value:s})=>{const i=this.mapEmit(t,s);i===null||(this.emit(i.type,i.value),this.emit("*",i))})}mapEmit(e,t){switch(e){case"userError":return{type:"error",value:t};case"concurrentQueue":return{type:"queue",value:{type:"concurrent",name:t.name,position:t.position}};case"queue":return{type:"queue",value:{type:"session",position:t.position}};case"deviceInfo":case"sessionInfo":case"sessionRequested":return{type:e,value:t}}return{type:e,value:t}}mapSend(e,t){return{type:e,value:t}}send(e,t){const s=this.mapSend(e,t);return this._socket.send(s.type,s.value)}disconnect(){return this._socket.disconnect()}}class fe extends R{constructor({socket:e,logger:t=new y}){super(),this.logger=t,this.socket=new de({socket:e}),this.socket.on("*",({type:s,value:i})=>{s!=="newSession"&&(this.emit(s,i),this.emit("*",{type:s,value:i}))}),this.socket.on("newSession",()=>{this.queue&&(this.emit("queueEnd"),this.queue=void 0)}),this.on("queue",s=>{this.queue=s})}on(e,t){return super.on(e,t)}async startSession(e){throw new Error("Not implemented")}async setConfig(e){throw new Error("Not implemented")}getConfig(){return this._config}async waitForSessionStart(e){return new Promise(async(t,s)=>{const i=()=>{s(new Error("Session disconnected before it was ready"))},r=a=>{s(new Error(`Session failed to start - ${typeof a.message=="object"?JSON.stringify(a.message):a.message}`))},o=a=>{a.message.match(/Too many requests/)&&s(new Error("Session failed to start due to too many requests"))};try{this.on("error",o),e.on("disconnect",i),e.on("error",r),await e.waitUntilReady()}catch(a){s(a)}finally{this.off("error",o),e.off("disconnect",i),e.off("error",r)}t(e)})}}function pe(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,n=>{const e=Math.random()*16|0;return(n==="x"?e:e&3|8).toString(16)})}function we(n){return Object.entries(n).map(([e,t])=>`${e}=${encodeURIComponent(t)}`).join("&")}function me(){let n,e,t,s;return{promise:new Promise((r,o)=>{t=a=>{n=a,r(a)},s=a=>{n=a,o(a)}}),resolve:t,reject:s,resolved:n,rejected:e}}function P(n){return Array.isArray(n)?n.map(P).filter(e=>e!=null):typeof n=="object"&&n!==null?Object.entries(n).reduce((e,[t,s])=>{const i=P(s);return i!=null&&(e[t]=i),e},{}):n}function G(n,e){if("captureStackTrace"in Error)Error.captureStackTrace(n,e);else{const t=new Error;Object.defineProperty(n,"stack",{configurable:!0,get(){const{stack:s}=t;return Object.defineProperty(this,"stack",{value:s}),s}})}}async function p(n,e){n instanceof g&&G(n,e)}class g extends Error{constructor(e){super(e),this.name="Error",this.isOperational=!0,G(this,this.constructor)}}class I extends g{constructor(e,t){super(t!=null?t:e.message),this.errorId=e.errorId,this.playback=e.playback}}class ye extends I{constructor(e){super(e,`No element found for selector
${JSON.stringify(e.playback.action.element,null,2)}`)}}class ge extends I{constructor(e){super(e,`Action requires 1 unique element but the selector returned ${e.matchedElements.length}. Provide a \`matchIndex\` to pick an element below or add additional attributes to your selector.

${ve(e.matchedElements)}`)}}class be extends I{constructor(e){let t=e.message;if(e.message.match("outside the screen bounds")){const{action:s}=e.playback;"localPosition"in s&&s.localPosition?t=`localPosition (${s.localPosition.x}, ${s.localPosition.y}) for the element evaluates to a coordinate outside of screen bounds.`:t="Element is outside of screen bounds."}super(e,t)}}class Q extends I{constructor(e){super(e,`An internal error has occurred for the action:
${JSON.stringify(e.playback.action,null,2)}`)}}class _ extends g{}class Z extends g{constructor(e,t){super(t),this.playback=e}}class N extends g{constructor(e){super(`App Recorder must be enabled to use ${e}. Please set "record" to true in the config.`)}}function ve(n){const t=n.slice(0,5),s=n.length>5;return`${t.map((r,o)=>`// ${o}
${JSON.stringify(r,null,2)}`).join(`

`)}${s?`

...and ${n.length-5} more`:""}`}async function D(n,e=5e3){const t=Date.now();let s=!1;for(;;)try{return await n(r=>{if(r)throw s=!0,r})}catch(i){if(await new Promise(r=>setTimeout(r,100)),s||e!==null&&Date.now()-t>e)throw i}}async function $(n){return new Promise(e=>setTimeout(e,n))}async function F(n,e,t){const s=typeof t=="function"?{}:t,i=typeof t=="function"?t:t==null?void 0:t.predicate,r=typeof(s==null?void 0:s.timeout)!="undefined"?s.timeout:1e4;return new Promise((o,a)=>{const h=c=>{(!i||i(c))&&(n.off(e,h),o(c))};n.on(e,h),r!==null&&setTimeout(()=>{n.off(e,h),a(new _(`Timeout ${r}ms exceeded while waiting for event "${e}"`))},r)})}class Ee extends fe{constructor({socket:e,window:t,logger:s=new y,config:i}){super({socket:e,logger:s}),this.ready=!1,this.isRequestingSession=!1,this._lastSetConfigCallId=null,this.window=t,i&&(this._config=this.mapConfig(i)),this.window.on("*",async({type:r,value:o})=>{if(this.ready)switch(r){case"app":this.app=o,this.emit(r,o);break;case"deviceInfo":this.device=o,this.emit(r,o);break;case"config":this._config=this.mapConfig(o);break}}),this.window.on("reinit",()=>{this.ready=!1,this.session=void 0,this.init({isReinit:!0})}),this.socket.on("*",async({type:r,value:o})=>{if(this.ready)switch(r){case"newSession":try{this.isRequestingSession=!1,this.session=this.createSession(this._config,{path:o.path,token:o.sessionToken}),await this.waitForSessionStart(this.session),this.emit("session",this.session)}catch(a){this.session=void 0,this.emit("sessionError",a)}}}),this.init()}async init(e={isReinit:!1}){await this.window.waitUntilReady();const t=async()=>{if(e.isReinit){const r=this._config,o=await this.setConfig({});return this.setConfig({record:!0,...r,...o})}else return this.setConfig({record:!0,...this._config})},[s,i]=await Promise.all([this.window.postMessage({type:"getApp"},!0),this.window.postMessage({type:"getDeviceInfo"},!0),t()]);this.app=s,this.device=i,this.ready=!0}async waitUntilReady(){if(!this.ready)return D(async()=>{if(!this.ready)throw new Error("Timed out waiting for client to be ready")},3e4)}async startSession(e){const t=this.isRequestingSession,s=()=>this.isRequestingSession===!1;this.isRequestingSession=!0;try{try{await this.waitUntilReady()}catch(i){const r=i instanceof Error?i.message:i;throw new Error(`Failed to start session. ${r}`)}if(s()||(this.session?await this.session.end():t&&(await this.cancelSessionRequest(),this.isRequestingSession=!0)),s()||await this.setConfig(e!=null?e:{}),s())throw new Error("Session request was cancelled");{const[i]=await Promise.all([new Promise((r,o)=>{const a=c=>{this.off("session",a),this.off("sessionError",h),r(c)},h=c=>{this.off("session",a),this.off("sessionError",h),o(c)};this.on("session",a),this.on("sessionError",h)}),this.window.postMessage({type:"requestSession"},!0)]);return i}}finally{this.isRequestingSession=!1}}async endSession(){this.session?await this.session.end():this.isRequestingSession&&await this.cancelSessionRequest()}async config(e){return this.logger.warn("client.config() is deprecated and will be removed in a future major release. Use client.setConfig() instead."),this.setConfig(e)}async setConfig({publicKey:e,...t}){this._lastSetConfigCallId=Math.random().toString(36);const s=this._lastSetConfigCallId;if(e){const r=await this.window.postMessage({type:"loadApp",value:e},!0);if(r&&"error"in r){if(r.error==="cancelled")return this._config;throw new Error(r.error)}if(s!==this._lastSetConfigCallId)return this._config}const i=await this.window.postMessage({type:"setConfig",value:this.validateConfig(t!=null?t:{})},!0).then(this.mapConfig.bind(this));return this._config=i,i}mapConfig(e){return e.autoplay===!0&&this.logger.warn.once("autoplay=true may cause the session to start before the SDK is ready. You should start the session programmatically using client.startSession() instead."),{...P(e),device:e.deviceType||e.device}}async cancelSessionRequest(){this.isRequestingSession&&(this.isRequestingSession=!1,await this.window.postMessage("endSession"),this.emit("sessionEnded"))}validateConfig(e){return e}createSession(e,t){throw new Error("Not implemented")}}function xe(n){const e=n.length;let t="";for(let s=0;s<e;s+=65535){let i=65535;s+65535>e&&(i=e-s),t+=String.fromCharCode.apply(null,n.subarray(s,s+i))}return t}function ke(n,e){if(typeof window=="undefined"&&typeof Buffer!="undefined"){const t=Buffer.from(n).toString("base64");return`data:${e};base64,`+t}else{const t=xe(n),s=btoa(t);return`data:${e};base64,`+s}}class Se{constructor({duration:e,stepDuration:t}){this.moves=[],this.duration=e,this.stepDuration=t!=null?t:16,this.moves=[{x:0,y:0}]}to(e,t){if(typeof e!="string"||typeof t!="string")throw new g('x and y must be strings and in percentages (e.g. "50%")');if(!e.endsWith("%")||!t.endsWith("%"))throw new g('x and y must be in percentages (e.g. "50%")');return this.moves.push({x:parseFloat(e)/100,y:parseFloat(t)/100}),this}wait(e){var s;const t=this.moves[this.moves.length-1];return t&&(t.wait=e+((s=t.wait)!=null?s:0)),this}build(){var a;const e=this.stepDuration,t=(a=this.duration)!=null?a:Math.max(500,e*(this.moves.length-1)),s=Math.floor(t/e),i=Math.floor(s/(this.moves.length-1)),r=[];let o=0;if(i===0){const h=(this.moves.length-1)*e;throw new Error(`Duration is too short for ${this.moves.length-1} moves, please set duration to at least ${h}ms`)}for(let h=0;h<this.moves.length-1;h++){const c=this.moves[h],l=this.moves[h+1],u=h===this.moves.length-2;for(let f=0;f<=i;f++){if(!u&&f===i)continue;const b=f/i,E=c.x+b*(l.x-c.x),x=c.y+b*(l.y-c.y),A=((h*i+f)*e+o)/1e3;r.push({x:E,y:x,t:A}),f===0&&c.wait&&(r.push({x:E,y:x,t:A+c.wait/1e3}),o+=c.wait)}if(h===this.moves.length-2&&l.wait){const f=r[r.length-1];r.push({x:f.x,y:f.y,t:f.t+l.wait/1e3})}}return r}up(e="50%"){const t=parseFloat(e);return this.to("0%",`-${t}%`)}down(e="50%"){const t=parseFloat(e);return this.to("0%",`${t}%`)}left(e="50%"){const t=parseFloat(e);return this.to(`-${t}%`,"0%")}right(e="50%"){const t=parseFloat(e);return this.to(`${t}%`,"0%")}}class k{static isValidElementSelector(e){if(typeof e!="object"||Array.isArray(e))throw new Error("Element must be an object");const t=Object.keys(e),i=Pe(t,["text","accessibilityIdentifier","accessibilityLabel","resource-id","content-desc","class","baseClass"]);if(i.length>0){const r=i.map(o=>`'${o}'`).join(", ");throw new Error(`Element has invalid properties: ${r}. Did you mean to put these under 'attributes'?`)}return e}static isCoordinatesWithinBounds(e,t){return!(e.x<0||e.x>t.width||e.y<0||e.y>t.height)}static isPositionWithinBounds(e){const t=m.toPositionValue(e.x),s=m.toPositionValue(e.y);return!(t<0||t>1||s<0||s>1)}static isValidNumber(e){return!(typeof e!="number"||isNaN(e))}}class m{static toBoolean(e){return e===1}static toNumber(e){return typeof e=="number"?e:typeof e=="boolean"||e===void 0?e?1:0:e==="inf"?1/0:e==="-inf"?-1/0:parseFloat(e)}static toObjCNumber(e){return e===1/0?"inf":e===-1/0?"-inf":e}static toPositionValue(e){if(typeof e=="string"){if(e.endsWith("%"))return parseInt(e,10)/100;throw new Error(`Invalid position value: ${e}. Must be a number between 0 and 1, or a string ending with %`)}return e}}function Pe(n,e){return n.filter(t=>e.includes(t))}class ee{constructor({platform:e,screen:t}){this.platform=e,this.screen=t}pixelToDip(e){return e/(this.screen.devicePixelRatio||1)}dipToPixel(e){return e*(this.screen.devicePixelRatio||1)}toInternal(e){const{attributes:t,bounds:s,...i}=e,r=()=>{if(s){const{x:a,y:h,width:c,height:l}=s;return this.platform==="android"?{x:this.dipToPixel(a),y:this.dipToPixel(h),width:this.dipToPixel(c),height:this.dipToPixel(l)}:{x:m.toObjCNumber(a),y:m.toObjCNumber(h),width:m.toObjCNumber(c),height:m.toObjCNumber(l)}}},o=()=>{if(t)return Object.keys(t).reduce((a,h)=>{if(this.platform==="ios")switch(h){case"userInteractionEnabled":case"isHidden":return{...a,[h]:t[h]?"1":"0"}}else this.platform;return{...a,[h]:t[h]}},{})};return P({...i,bounds:r(),attributes:o(),accessibilityElements:void 0})}toPublic(e){const{attributes:t,bounds:s,accessibilityElements:i,...r}=e,o=c=>this.platform==="android"?{x:this.pixelToDip(c.x),y:this.pixelToDip(c.y),width:this.pixelToDip(c.width),height:this.pixelToDip(c.height)}:{x:m.toNumber(c.x),y:m.toNumber(c.y),width:m.toNumber(c.width),height:m.toNumber(c.height)},a=c=>Object.keys(c).reduce((l,u)=>{switch(u){case"userInteractionEnabled":case"isHidden":return{...l,[u]:c[u]==="1"};default:return{...l,[u]:c[u]}}},{}),h=c=>c.map(l=>{const{accessibilityFrame:u}=l;return{...a(l),accessibilityFrame:u?o(u):void 0}});return P({...r,bounds:s?o(s):void 0,attributes:t?a(t):void 0,accessibilityElements:i?h(i):void 0})}}class te{constructor({platform:e,screen:t}){this.platform=e,this.screen=t,this.elementMapper=new ee({platform:e,screen:t})}pixelToDip(e){return e/(this.screen.devicePixelRatio||1)}dipToPixel(e){return e*(this.screen.devicePixelRatio||1)}getCoordinates(e,t){const s=m.toPositionValue(e.x),i=m.toPositionValue(e.y);return{x:s*t.width,y:i*t.height}}getPosition(e,t){return{x:e.x/t.width,y:e.y/t.height}}toInternalKey(e){switch(e){case"HOME":return"home";case"VOLUME_UP":return"volumeUp";case"VOLUME_DOWN":return"volumeDown"}return e}toPublicKey(e){switch(e){case"home":return"HOME";case"volumeUp":return"VOLUME_UP";case"volumeDown":return"VOLUME_DOWN"}return e}toInternal(e){return P((()=>{e=P(e);let s,i,r;if("element"in e&&e.element&&(s=this.elementMapper.toInternal(e.element)),"position"in e&&e.position){const o=m.toPositionValue(e.position.x),a=m.toPositionValue(e.position.y);if(!k.isValidNumber(o)||!k.isValidNumber(a))throw new g(`Invalid position: (${e.position.x}, ${e.position.y}). Values must be a number or a percentage`);if(!k.isPositionWithinBounds(e.position))throw typeof e.position.x=="string"?new Error(`Invalid position: (${e.position.x}, ${e.position.y}) must be within (0%, 0%) and (100%, 100%)`):new Error(`Invalid position: (${e.position.x}, ${e.position.y}) must be within (0, 0) and (1, 1)`);this.platform==="android"?i=this.getCoordinates(e.position,{width:this.dipToPixel(this.screen.width)-1,height:this.dipToPixel(this.screen.height)-1}):i=this.getCoordinates(e.position,{width:this.screen.width-1,height:this.screen.height-1})}else if("coordinates"in e&&e.coordinates){if(!k.isValidNumber(e.coordinates.x)||!k.isValidNumber(e.coordinates.y))throw new g(`Invalid coordinates: (${e.coordinates.x}, ${e.coordinates.y}). Values must be a number`);if(!k.isCoordinatesWithinBounds(e.coordinates,{width:this.screen.width-1,height:this.screen.height-1}))throw new g(`Invalid coordinates: (${e.coordinates.x}, ${e.coordinates.y}) exceed screen bounds (${this.screen.width-1}, ${this.screen.height-1})`);this.platform==="android"?i={x:this.dipToPixel(e.coordinates.x),y:this.dipToPixel(e.coordinates.y)}:i=e.coordinates}if("localPosition"in e&&e.localPosition){const o=m.toPositionValue(e.localPosition.x),a=m.toPositionValue(e.localPosition.y);if(!k.isValidNumber(o)||!k.isValidNumber(a))throw new g(`Invalid localPosition: (${e.localPosition.x}, ${e.localPosition.y}). Values must be a number or a percentage`);r={x:o,y:a}}else s&&(r={x:.5,y:.5});if("duration"in e&&e.duration&&!k.isValidNumber(e.duration))throw new g(`Invalid duration: ${e.duration}. Value must be a number`);switch(e.type){case"tap":{const{position:o,...a}=e;return{...a,element:s,localPosition:r,coordinates:i}}case"swipe":{const{position:o,...a}=e;return{...a,element:s,localPosition:r,coordinates:i,moves:e.moves.map(h=>{if(this.platform==="android"){const{x:c,y:l}=this.getCoordinates(h,{width:this.dipToPixel(this.screen.width)-1,height:this.dipToPixel(this.screen.height)-1});return{...h,x:c,y:l}}else{const{x:c,y:l}=this.getCoordinates(h,{width:this.screen.width-1,height:this.screen.height-1});return{...h,x:c,y:l}}})}}case"keypress":{const o=this.toInternalKey(e.key),a=this.toInternalKey(e.character);return{...e,key:o,character:a,shiftKey:this.platform==="ios"?m.toNumber(e.shiftKey):e.shiftKey}}case"findElements":return{...e,element:s}}return e})())}toPublic(e){return P((()=>{let s,i,r,o="localPosition"in e?e.localPosition:void 0;switch("coordinates"in e&&e.coordinates&&(i={x:this.pixelToDip(e.coordinates.x),y:this.pixelToDip(e.coordinates.y)},r=this.getPosition(i,{width:this.screen.width-1,height:this.screen.height-1})),"element"in e&&e.element&&(s=this.elementMapper.toPublic(e.element),i&&s.bounds&&(o=this.getPosition({x:i.x-s.bounds.x,y:i.y-s.bounds.y},{width:s.bounds.width,height:s.bounds.height}))),e.type){case"tap":return{...e,coordinates:i,element:s,position:r,localPosition:o};case"swipe":return{...e,coordinates:i,element:s,position:r,localPosition:o,moves:e.moves.map(a=>{const{x:h,y:c}=this.getPosition({x:this.pixelToDip(a.x),y:this.pixelToDip(a.y)},{width:this.screen.width-1,height:this.screen.height-1});return{x:h,y:c,t:a.t}})};case"keypress":{const a=this.toPublicKey(e.key),h=this.toPublicKey(e.character);return{...e,key:a,character:h,shiftKey:typeof e.shiftKey=="number"?m.toBoolean(e.shiftKey):Boolean(e.shiftKey)}}case"findElements":return{...e,element:s}}return e})())}}class Ce extends R{constructor({socket:e,platform:t,screen:s,app:i}){super(),this._socket=e,this.platform=t,this.screen=s,this.app=i,e.on("*",({type:r,value:o})=>{const a=this.mapEmit(r,o);a===null||(this.handleEvent(a.type,a.value),this.emit(a.type,a.value),this.emit("*",a))})}send(e,t){const s=this.mapSend(e,t);return this._socket.send(s.type,s.value)}disconnect(){return this._socket.disconnect()}handleEvent(e,t){switch(e){case"app":this.app=t;break;case"deviceInfo":{const s=t;s!=null&&s.screen&&(this.screen=s.screen);break}case"config":{const s=t;s.platform&&(this.platform=s.platform);break}}}mapEmit(e,t){var r,o,a,h;const s=new te({platform:this.platform,screen:this.screen}),i=new ee({platform:this.platform,screen:this.screen});switch(e){case"debug":return{type:"log",value:t};case"interceptResponse":return{type:"network",value:{type:"response",...t}};case"interceptRequest":return{type:"network",value:{type:"request",...t}};case"interceptError":return{type:"network",value:{type:"error",...t}};case"userError":return{type:"error",value:t};case"userInteractionReceived":return{type:"interaction",value:t};case"countdownWarning":return{type:"inactivityWarning",value:t};case"h264Data":return{type:"video",value:{...t,codec:"h264"}};case"frameData":return{type:"video",value:{...t,codec:"jpeg"}};case"audioData":return{type:"audio",value:{...t,codec:"aac"}};case"deviceInfo":case"sessionRequested":case"orientationChanged":return{type:e,value:t};case"chromeDevToolsUrl":return{type:"networkInspectorUrl",value:t};case"recordedAction":return{type:"action",value:s.toPublic(t)};case"playbackFoundAndSent":{const c=t;return{type:"playbackFoundAndSent",value:{...c,playback:{...c.playback,action:c.playback.action?s.toPublic(c.playback.action):void 0},matchedElements:(r=c.matchedElements)==null?void 0:r.map(l=>{if(l)return i.toPublic(l)})}}}case"playbackError":{const c=t;return{type:"playbackError",value:{...c,playback:{...c.playback,action:c.playback.action?s.toPublic(c.playback.action):void 0},matchedElements:(o=c.matchedElements)==null?void 0:o.map(l=>{if(l)return i.toPublic(l)})}}}case"uiDump":{const c=(a=t.ui)!=null?a:t.result,l=t.springboard,u=b=>{var E;return{...i.toPublic(b),children:(E=b.children)==null?void 0:E.map(u)}},f=[];return c&&(this.platform==="ios"?f.push({type:"app",appId:(h=this.app)==null?void 0:h.bundle,children:c.map(u)}):f.push({type:"app",children:c.map(u)})),l&&f.push({type:"app",appId:"com.apple.springboard",children:l.map(u)}),{type:"uiDump",value:f}}case"deleteEvent":return null}return{type:e,value:t}}mapSend(e,t){const s=new te({platform:this.platform,screen:this.screen});switch(e){case"playAction":{const i=t,o=t.__noMap__?t.action:s.toInternal(i.action);return{type:e,value:{...i,action:o}}}}return{type:e,value:t}}}class Ae extends R{constructor({socket:t,config:s,path:i,token:r,app:o,device:a,logger:h=new y}){super();U(this,C,void 0);U(this,T,void 0);this.isEndingManually=!1,this.countdownWarning=!1,this.ready=!1,this._waitForAnimationsPromises=new Set,this.config=s,this.socket=new Ce({socket:t,app:o,screen:a.screen,platform:s.platform}),this.device=a,this.app=o,this.path=i,this.token=r,this.logger=h;const c=({type:l,value:u})=>{switch(l){case"ready":this.ready=!0;break;case"adbOverTcp":{W(this,C,{...u,command:Le(u)});break}case"networkInspectorUrl":W(this,T,u);break;case"countdownWarning":this.countdownWarning=!0;break;case"timeoutReset":this.countdownWarning=!1;break;case"deviceInfo":this.device=u;break;case"disconnect":this.emit("end"),this.emit("*",{type:"end"});break}this.emit(l,u),this.emit("*",{type:l,value:u})};this.socket.on("*",c),this.on("disconnect",()=>{this.socket.off("*",c),this.isEndingManually||(this.countdownWarning?this.logger.warn("Appetize session has ended due to inactivity"):this.logger.warn("Session disconnected"))})}on(t,s){return t==="network"&&this.config.proxy!=="intercept"&&this.logger.warn('Session must be configured with `proxy: "intercept"` to listen to network events.'),t==="log"&&this.config.debug!==!0&&this.logger.warn("Session must be configured with `debug: true` to listen to log events."),t==="action"&&this.config.record!==!0&&this.logger.warn("Session must configured with `record: true` to listen to action events."),super.on(t,s)}async waitUntilReady(){let t=!0;const s=async r=>new Promise(o=>{const a=setInterval(()=>{r()&&o(void 0)},10);setTimeout(()=>{clearInterval(a),o(void 0)},3e3)}),i=()=>{t=!1};this.socket.once("disconnect",i);try{await D(r=>{if(!this.ready){if(t)throw new _("Timed out after 180s waiting for session to be ready");r(new Error("Session disconnected"))}},18e4)}finally{this.socket.off("disconnect",i)}await Promise.all([this.config.proxy==="intercept"?s(()=>Boolean(L(this,T))):Promise.resolve(),this.config.enableAdb?s(()=>Boolean(L(this,C))):Promise.resolve()])}async waitForEvent(t,s){try{return await F(this,t,s)}catch(i){throw p(i,this.waitForEvent),i}}async end(){this.isEndingManually=!0,await this.socket.disconnect()}get networkInspectorUrl(){return this.config.proxy!=="intercept"&&this.logger.warn('Session must be configured with `proxy: "intercept"` to use the network inspector'),L(this,T)}get adbConnection(){if(this.config.platform&&this.config.platform!=="android"&&this.logger.warn("Session must be connected to an Android device to use adb"),this.config.enableAdb||this.logger.warn("Session must be configured with `enableAdb: true` to use adb"),L(this,C))return L(this,C)}async rotate(t){try{const[s]=await Promise.all([this.waitForEvent("orientationChanged"),this.socket.send("userInteraction",{type:"keypress",key:t==="left"?"rotateLeft":"rotateRight",timeStamp:Date.now()})]);return s}catch(s){throw p(s,this.rotate),s}}async screenshot(t="buffer"){var s;try{this.socket.send("getScreenshot",{});const i=await F(this.socket,"screenshot",{timeout:6e4});if(!i.success)throw new g((s=i.error)!=null?s:"Screenshot failed");return{data:t==="buffer"?(a=>typeof window=="undefined"?Buffer.from(a):a)(i.data):ke(new Uint8Array(i.data),i.mimeType),mimeType:i.mimeType}}catch(i){throw p(i,this.screenshot),i}}async heartbeat(){try{return await this.socket.send("heartbeat")}catch(t){throw p(t,this.heartbeat),t}}async type(t){try{await $(1e3);const s=await this.playAction({type:"typeText",text:t});return await $(500),s}catch(s){throw p(s,this.type),s}}async keypress(t,s){try{if(t==="ANDROID_KEYCODE_MENU")return await this.socket.send("androidKeycodeMenu");if((s==null?void 0:s.shift)||t==="HOME"){switch(t){case"ArrowUp":t="arrowUp";break;case"ArrowDown":t="arrowDown";break;case"ArrowLeft":t="arrowLeft";break;case"ArrowRight":t="arrowRight";break;case"Enter":t="\r";break;case"Tab":t="	";break;case"Backspace":t="\b";break}return this.playAction({type:"keypress",key:t,shiftKey:!!(s!=null&&s.shift)})}else return this.playAction({type:"keypress",character:t})}catch(i){throw p(i,this.keypress),i}}async setLanguage(t){try{return this.config.language=t,await this.socket.send("setLanguage",{language:t,timeStamp:Date.now()})}catch(s){throw p(s,this.setLanguage),s}}async setLocation(t,s){try{if(typeof t!="number"||typeof s!="number")throw new g("setLocation requires latitude and longitude to be numbers");const i=[t,s];return this.config.location=i,await this.socket.send("setLocation",{location:i,timeStamp:Date.now()})}catch(i){throw p(i,this.setLocation),i}}async openUrl(t){try{return await this.socket.send("openUrl",{url:t,timeStamp:Date.now()})}catch(s){throw p(s,this.openUrl),s}}async shake(){try{return await this.socket.send("shakeDevice")}catch(t){throw p(t,this.swipe),t}}async toggleSoftKeyboard(){try{if(this.config.platform!=="ios")throw new Error("toggleSoftKeyboard is only available on iOS devices");return await this.socket.send("toggleSoftKeyboard")}catch(t){throw p(t,this.toggleSoftKeyboard),t}}async biometry({match:t}){try{return await this.socket.send(t?"biometryMatch":"biometryNoMatch")}catch(s){throw p(s,this.biometry),s}}async allowInteractions(t){try{return await this.socket.send(t?"enableInteractions":"disableInteractions")}catch(s){throw p(s,this.allowInteractions),s}}async restartApp(){try{this.socket.send("restartApp");const{platform:t}=this.config;t==="ios"?await this.waitForEvent("appLaunch",{timeout:6e4}):await $(1e3)}catch(t){throw p(t,this.restartApp),t}}async reinstallApp(){try{this.socket.send("reinstallApp"),await this.waitForEvent("appLaunch",{timeout:6e4})}catch(t){throw p(t,this.reinstallApp),t}}async adbShellCommand(t){if(this.config.platform!=="android")throw new Error("adbShellCommand is only available on Android devices");try{return await this.socket.send("adbShellCommand",{command:t,timeStamp:Date.now()})}catch(s){throw p(s,this.adbShellCommand),s}}async playAction(t,s={}){const{timeout:i=1e4}=s,r=1e4,o=i+3e4;try{if(!this.config.record)throw new N("playAction()");if(isNaN(i))throw new g(`Invalid timeout value: ${s.timeout}`);if(i<0)throw new g(`Timeout value cannot be negative: ${s.timeout}`);"element"in t&&t.element&&k.isValidElementSelector(t.element);const a={id:pe(),action:t,options:{...s,timeout:Math.round(Math.min(i,r)/1e3)}};try{return await new Promise((c,l)=>{const u=setTimeout(()=>{f(),l(new Z({id:a.id,action:t,timeout:a.options.timeout},"Timed out waiting for response from device"))},o),f=()=>{this.off("playbackFoundAndSent",b),this.off("playbackError",E),clearTimeout(u)},b=async x=>{var A;((A=x.playback)==null?void 0:A.id)===a.id&&(f(),c(x))},E=async x=>{var A;if(((A=x.playback)==null?void 0:A.id)===a.id)switch(f(),x.errorId){case"internalError":l(new Q(x));break;case"notFound":{l(new ye(x));break}case"ambiguousMatch":l(new ge(x));break;case"invalidArgument":{l(new be(x));break}default:l(new I(x));break}};this.on("playbackFoundAndSent",b),this.on("playbackError",E),this.socket.send("playAction",a)})}catch(h){const c=Math.max(0,i-r);if(c>0&&!(h instanceof Z)&&!(h instanceof Q))return await this.playAction(t,{...s,timeout:c});throw h}}catch(a){throw p(a,this.playAction),a}}async playActions(t,s={}){try{if(!this.config.record)throw new N("playActions()");const i=[];for(const r of t){const o=await this.playAction(r,s);i.push(o);const a=t[t.indexOf(r)+1];a&&a.type==="keypress"&&r.type==="keypress"||await this.waitForAnimations({timeout:2e3}).catch(()=>{})}return i}catch(i){throw p(i,this.playActions),i}}async getUI({timeout:t=3e4}={}){try{return this.socket.send("dumpUi"),await F(this,"uiDump",{timeout:t})}catch(s){throw p(s,this.getUI),s}}async findElement(t,s){var i;try{return(i=(await this.playAction({type:"findElements",element:t,appId:s==null?void 0:s.appId},s)).matchedElements)==null?void 0:i[0]}catch(r){throw p(r,this.findElement),r}}async findElements(t,s){try{return(await this.playAction({type:"findElements",element:t,appId:s==null?void 0:s.appId},s)).matchedElements}catch(i){throw p(i,this.findElements),i}}async tap(t,s){var i;try{if(!this.config.record)throw new N("tap()");return await this.playAction({type:"tap",...t,duration:((i=t.duration)!=null?i:0)/1e3},s)}catch(r){throw p(r,this.tap),r}}async swipe({duration:t,gesture:s,...i},r){try{if(!this.config.record)throw new N("swipe()");let o;const a=new Se({duration:t,stepDuration:i.stepDuration});if(typeof s=="function")s(a);else switch(s){case"up":a.up();break;case"down":a.down();break;case"left":a.left();break;case"right":a.right();break}if("element"in i)o={type:"swipe",element:i.element,localPosition:i.localPosition,moves:a.build()};else if("position"in i)o={type:"swipe",position:i.position,moves:a.build()};else throw new Error("Either element or position must be specified");return this.playAction(o,r)}catch(o){throw p(o,this.swipe),o}}async waitForAnimations(t={}){try{const{imageThreshold:s=.001,timeout:i=1e4}=t;let r=1e3,o=1;t.imageThresholdDuration&&(r=t.imageThresholdDuration);const{promise:a,resolve:h,reject:c}=me(),l=setTimeout(()=>{let b=`Timed out after ${i}ms waiting for animation to end.`;s<o&&(b+=` Waited for imageThreshold of ${s} but lowest was ${Math.round(o*1e4)/1e4}`),c(new _(b))},i);let u;const f=({percentage:b,timestamp:E})=>{b<o&&(o=b),b<=s?(u||(u=E),u&&E-u>=r&&h()):u=void 0};return this.socket.send("enablePixelChangeDetection"),this.socket.on("pixelsChanged",f),this._waitForAnimationsPromises.add(a),await a.finally(()=>{clearTimeout(l),this.socket.off("pixelsChanged",f),this._waitForAnimationsPromises.delete(a),this._waitForAnimationsPromises.size===0&&this.socket.send("disablePixelChangeDetection")})}catch(s){throw p(s,this.waitForAnimations),s}}async getAdbInfo(){return this.logger.warn("getAdbInfo() is deprecated. Please use the `adbConnection` property instead."),Promise.resolve(L(this,C))}async getNetworkInspectorUrl(){return this.logger.warn("getNetworkInspectorUrl() is deprecated. Please use the `networkInspectorUrl` property instead."),Promise.resolve(L(this,T))}async getDeviceInfo(){return this.logger.warn("getDeviceInfo() is deprecated. Please use the `device` property instead."),Promise.resolve(this.device)}}C=new WeakMap,T=new WeakMap;function Le(n){const e="ssh -fN -o StrictHostKeyChecking=no -oHostKeyAlgorithms=+ssh-rsa -p SERVER_PORT USERNAME@HOSTNAME -L6000:FORWARD_DESTINATION:FORWARD_PORT && adb connect localhost:6000";if(!n||!n.forwards[0])return;let t=e;return t=t.replace(/SERVER_PORT/,n.port.toString()),t=t.replace(/USERNAME/,n.user),t=t.replace(/HOSTNAME/,n.hostname),t=t.replace(/FORWARD_DESTINATION/,n.forwards[0].destination),t=t.replace(/FORWARD_PORT/,n.forwards[0].port.toString()),t}class se extends R{constructor({window:e,type:t}){super(),this.type=t,this.window=e,this.window.on("*",({type:s,value:i})=>{switch(s){case"socketEvent":i.socket===this.type&&(this.emit(i.type,i.value),this.emit("*",{type:i.type,value:i.value}));break;case"disconnect":this.emit("disconnect"),this.emit("*",{type:"disconnect"});break;case"sessionInfo":case"chromeDevToolsUrl":case"orientationChanged":case"deviceInfo":this.type==="appetizer"&&(this.emit(s,i),this.emit("*",{type:s,value:i}));break;case"sessionRequested":this.type==="webserver"&&(this.emit(s,i),this.emit("*",{type:s,value:i}));break}})}async send(e,t){var s;await this.window.waitUntilReady(),await((s=this.window)==null?void 0:s.postMessage({type:"emitSocketEvent",value:{type:e,value:t,socket:this.type}}))}async disconnect(){return this.send("disconnect")}async waitForEvent(e,t){return F(this,e,t)}}class Te extends Ae{constructor({window:e,config:t,...s}){const i=new se({window:e,type:"appetizer"});super({...s,config:t,socket:i,logger:new y}),this.window=e}async rotate(e){try{const[t]=await Promise.all([this.waitForEvent("orientationChanged"),this.window.postMessage(e==="left"?"rotateLeft":"rotateRight")]);return await $(1e3),t}catch(t){throw p(t,this.rotate),t}}async end(){this.isEndingManually=!0,await this.window.postMessage("endSession")}}const ie="1.2.3";class Re extends R{constructor({selector:e,config:t}={}){super(),this.selector=e,this.initialConfig=t,this.handleWindowMessage=this.handleWindowMessage.bind(this),window.addEventListener("message",this.handleWindowMessage),this.init()}async init(){await new Promise((e,t)=>{let s;const i=()=>{s==null||s.disconnect(),clearTimeout(r),clearInterval(o)},r=setTimeout(()=>{this.selector&&(i(),t(new _(`Timed out after 60000ms waiting for Appetize iframe with selector "${this.selector}"`)))},6e4),o=setInterval(()=>{var c,l,u;const a=new MessageChannel;this.contentWindow=this.getContentWindow();const h=this.getIframe();if(this.contentWindow)a.port1.onmessage=()=>{if(this.ready=!0,i(),h){const f=()=>{i(),this.emit("reinit"),this.ready=!1,this.init()};s=Ie(h,{onSrcChange:()=>{this.ready=!1},onLoad:f,onRemoved:f})}e(void 0)},(c=this.contentWindow)==null||c.postMessage({type:"init",appetizeClient:!0,version:ie},"*",[a.port2]);else if(h&&!h.src){const f=(l=h.getAttribute("data-appetize-url"))!=null?l:"https://appetize.io";if((u=this.initialConfig)!=null&&u.publicKey){const{publicKey:b,...E}=this.initialConfig;h.src=`${f}/embed/${this.initialConfig.publicKey}?${we(E)}`}else throw i(),new Error("Missing publicKey in config in getClient()")}},100)})}async waitUntilReady(){return D(async()=>{if(this.selector&&!this.getContentWindow())throw new Error(`iframe not found for selector "${this.selector}"`);await D(()=>{if(!this.ready)throw new Error("iframe was found but content did not load")},2e4)},5e3)}async postMessage(e,t=!1){var i;await this.waitUntilReady();const s=new MessageChannel;if((i=this.contentWindow)==null||i.postMessage(e,"*",[s.port2]),t)return new Promise((r,o)=>{const a=setTimeout(()=>{o(new _("Timed out after 60000ms while waiting for postMessage response"))},6e4);s.port1.onmessage=h=>{clearTimeout(a),s.port1.close(),s.port2.close(),r(h.data)}});s.port1.close(),s.port2.close()}getContentWindow(){var e;if(this.selector){const t=this.getIframe();if(t!=null&&t.src)return(e=t.contentWindow)!=null?e:void 0}else return window}getIframe(){if(this.selector)return document.querySelector(this.selector)}handleWindowMessage(e){var s,i,r;const t=typeof e.data=="string"?e.data:(s=e.data)==null?void 0:s.type;this.contentWindow&&e.source===this.contentWindow&&(this.emit(t,(i=e.data)==null?void 0:i.value),this.emit("*",{type:t,value:(r=e.data)==null?void 0:r.value}))}}function Ie(n,e){const t=n.src,s=()=>{n.src!==t&&e.onLoad()},i=()=>{n.removeEventListener("load",s),r.disconnect()};n.addEventListener("load",s);const r=new MutationObserver(o=>{o.forEach(a=>{a.type==="attributes"?a.target===n&&a.attributeName==="src"&&e.onSrcChange():a.type==="childList"&&a.removedNodes.forEach(h=>{h===n&&e.onRemoved()})})});return r.observe(document.body,{childList:!0,subtree:!0,attributes:!0}),{disconnect:i}}class ne extends Ee{constructor({selector:e,config:t}={}){const s=new Re({selector:e,config:t});super({socket:new se({window:s,type:"webserver"}),config:t,window:s}),this.ready=!1}createSession(e,t){return this.session=new Te({window:this.window,config:e,path:t.path,token:t.token,device:this.device,app:this.app}),this.session.on("end",()=>{this.session=void 0,this.emit("sessionEnded")}),this.session}}async function _e(n,e){if(!n)throw new Error("selector is required");const t=new ne({selector:n,config:e});return await t.waitUntilReady(),t}function Me(n){return new ne({config:n})}const Oe=ie;return w.getClient=_e,w.getWindowClient=Me,w.version=Oe,Object.defineProperties(w,{__esModule:{value:!0},[Symbol.toStringTag]:{value:"Module"}}),w}({});
//# sourceMappingURL=embed.js.map
